<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BondVoyage â”‚ Admin Home</title>
    <link rel="stylesheet" href="../CSS/bv_adminhome.css">
    <link rel="stylesheet" href="../CSS/themes.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="../Images/favicon-32x32.png" type="image/png">
</head>
<body>
    <header class="header">
        <div class="logo1">
          <img src="../Images/logo_title.png" alt="Logo" />
        </div>
        <div class="hamburger-menu" onclick="toggleMenu()">
          &#9776;
        </div>
      </header>
      
      <div id="nav-menu" class="nav-menu">
        <ul>
          <li><a href="../Admin_HTML/bv_adminhome.html">Home</a></li>
          <div class="divider2"></div>
          <li><a href="../Admin_HTML/bv_users.html">Users</a></li>
          <div class="divider2"></div>
          <li><a href="../Admin_HTML/bv_usersitinerary.html">User's Itinerary</a></li>
          <div class="divider2"></div>
          <li><a href="../Admin_HTML/bv_standard.html">Standard Itinerary</a></li>
          <div class="divider2"></div>
          <li><a href="../Admin_HTML/bv_placeguide.html">Place Guide</a></li>
          <div class="divider2"></div>
          <li><a href="../Admin_HTML/bv_adminlogin.html">Log Out</a></li>
        </ul>
      </div>

    <div class="container">
        <nav class="sidebar">
            <ul class="menu">
                <li class="active"><a href="../Admin_HTML/bv_adminhome.html">
                        <svg width="45" height="45" viewBox="0 0 512 512">
                            <path d="M80,212V448a16,16,0,0,0,16,16h96V328a24,24,0,0,1,24-24h80a24,24,0,0,1,24,24V464h96a16,16,0,0,0,16-16V212" 
                                style="fill:none; stroke: var(--svg-color); stroke-linecap:round; stroke-linejoin:round; stroke-width:45px"/>
                            <path d="M480,256,266.89,52c-5-5.28-16.69-5.34-21.78,0L32,256" 
                                style="fill:none; stroke: var(--svg-color); stroke-linecap:round; stroke-linejoin:round; stroke-width:45px"/>
                            <polyline points="400 179 400 64 352 64 352 133" 
                                    style="fill:none; stroke: var(--svg-color); stroke-linecap:round; stroke-linejoin:round; stroke-width:45px"/>
                        </svg>
                        <span style="color: var(--svg-color);">Home</span>
                    </a>
                </li>
                <li><a href="../Admin_HTML/bv_users.html">
                        <svg width="45" height="45" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <style>
                                .users-stroke {
                                    fill: none;
                                    stroke: var(--svg-color);
                                    stroke-width: 2;
                                    stroke-linecap: round;
                                    stroke-linejoin: round;
                                }
                            </style>
                            <path class="users-stroke" d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle class="users-stroke" cx="12" cy="7" r="4"/>
                        </svg>
                        <span style="color: var(--svg-color);">Users</span>
                    </a>
                </li>
                <li><a href="../Admin_HTML/bv_usersitinerary.html">
                        <svg width="45" height="45" viewBox="0 0 32 32">
                            <path d="M27,27H5c-1.1,0-2-0.9-2-2V12c0-1.1,0.9-2,2-2h22c1.1,0,2,0.9,2,2v13C29,26.1,28.1,27,27,27z"
                                style="fill:none; stroke: var(--svg-color); stroke-width:2.5; stroke-linecap:round; stroke-linejoin:round; stroke-miterlimit:10"/>
                            <line x1="9" y1="10" x2="9" y2="27" 
                                style="fill:none; stroke: var(--svg-color); stroke-width:2.5; stroke-linecap:round; stroke-linejoin:round; stroke-miterlimit:10"/>
                            <line x1="23" y1="10" x2="23" y2="27" 
                                style="fill:none; stroke: var(--svg-color); stroke-width:2.5; stroke-linecap:round; stroke-linejoin:round; stroke-miterlimit:10"/>
                            <path d="M21,10H11V8c0-1.1,0.9-2,2-2h6c1.1,0,2,0.9,2,2V10z"
                                style="fill:none; stroke: var(--svg-color); stroke-width:2.5; stroke-linecap:round; stroke-linejoin:round; stroke-miterlimit:10"/>
                            <line x1="5" y1="28" x2="5" y2="27" 
                                style="fill:none; stroke: var(--svg-color); stroke-width:2.5; stroke-linecap:round; stroke-linejoin:round; stroke-miterlimit:10"/>
                            <line x1="27" y1="28" x2="27" y2="27" 
                                style="fill:none; stroke: var(--svg-color); stroke-width:2.5; stroke-linecap:round; stroke-linejoin:round; stroke-miterlimit:10"/>
                        </svg>
                        <span style="color: var(--svg-color);">User's Itinerary</span>
                    </a>
                </li>
                <li><a href="../Admin_HTML/bv_standard.html">
                        <svg width="45" height="45" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <style>
                                .standard-stroke {
                                    fill: none;
                                    stroke: var(--svg-color);
                                    stroke-width: 2;
                                    stroke-linecap: round;
                                    stroke-linejoin: round;
                                }
                            </style>
                            <path class="standard-stroke" d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline class="standard-stroke" points="14,2 14,8 20,8"/>
                            <line class="standard-stroke" x1="16" y1="13" x2="8" y2="13"/>
                            <line class="standard-stroke" x1="16" y1="17" x2="8" y2="17"/>
                            <polyline class="standard-stroke" points="10,9 9,9 8,9"/>
                        </svg>
                        <span style="color: var(--svg-color);">Standard Itinerary</span>
                    </a>
                </li>
                <li><a href="../Admin_HTML/bv_placeguide.html">
                        <svg width="45" height="45" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <style>
                                .place-stroke {
                                    fill: none;
                                    stroke: var(--svg-color);
                                    stroke-width: 2;
                                    stroke-linecap: round;
                                    stroke-linejoin: round;
                                }
                            </style>
                            <path class="place-stroke" d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                            <circle class="place-stroke" cx="12" cy="10" r="3"/>
                        </svg>
                        <span style="color: var(--svg-color);">Place Guide</span>
                    </a>
                </li>
                <li><a href="../Admin_HTML/bv_feedbackrecord.html">
                        <svg width="40px" height="40px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <style type="text/css">
                                .feedback-fill {
                                    fill: var(--svg-color);
                                }
                                .feedback-stroke {
                                    fill: none;
                                    stroke: var(--svg-color);
                                    stroke-width: 1.5;
                                    stroke-linecap: round;
                                    stroke-linejoin: round;
                                }
                            </style>
                            <path class="feedback-fill" d="M16 1C17.6569 1 19 2.34315 19 4C19 4.55228 18.5523 5 18 5C17.4477 5 17 4.55228 17 4C17 3.44772 16.5523 3 16 3H4C3.44772 3 3 3.44772 3 4V20C3 20.5523 3.44772 21 4 21H16C16.5523 21 17 20.5523 17 20V19C17 18.4477 17.4477 18 18 18C18.5523 18 19 18.4477 19 19V20C19 21.6569 17.6569 23 16 23H4C2.34315 23 1 21.6569 1 20V4C1 2.34315 2.34315 1 4 1H16Z"/>
                            <path class="feedback-fill" fill-rule="evenodd" clip-rule="evenodd" d="M20.7991 8.20087C20.4993 7.90104 20.0132 7.90104 19.7133 8.20087L11.9166 15.9977C11.7692 16.145 11.6715 16.3348 11.6373 16.5404L11.4728 17.5272L12.4596 17.3627C12.6652 17.3285 12.855 17.2308 13.0023 17.0835L20.7991 9.28666C21.099 8.98682 21.099 8.5007 20.7991 8.20087ZM18.2991 6.78666C19.38 5.70578 21.1325 5.70577 22.2134 6.78665C23.2942 7.86754 23.2942 9.61999 22.2134 10.7009L14.4166 18.4977C13.9744 18.9398 13.4052 19.2327 12.7884 19.3355L11.8016 19.5C10.448 19.7256 9.2744 18.5521 9.50001 17.1984L9.66448 16.2116C9.76728 15.5948 10.0602 15.0256 10.5023 14.5834L18.2991 6.78666Z"/>
                            <path class="feedback-stroke" d="M5 7C5 6.44772 5.44772 6 6 6H14C14.5523 6 15 6.44772 15 7C15 7.55228 14.5523 8 14 8H6C5.44772 8 5 7.55228 5 7Z"/>
                            <path class="feedback-stroke" d="M5 11C5 10.4477 5.44772 10 6 10H10C10.5523 10 11 10.4477 11 11C11 11.5523 10.5523 12 10 12H6C5.44772 12 5 11.5523 5 11Z"/>    
                            <path class="feedback-stroke" d="M5 15C5 14.4477 5.44772 14 6 14H7C7.55228 14 8 14.4477 8 15C8 15.5523 7.55228 16 7 16H6C5.44772 16 5 15.5523 5 15Z"/>
                        </svg>
                        <span style="color: var(--svg-color);">Feedback</span>
                    </a>
                </li>
                <li><a href="../PHP/bv_adminlogout.php">
                        <svg width="45" height="45" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <style>
                                .logout-stroke {
                                    fill: none;
                                    stroke: var(--svg-color);
                                    stroke-width: 2;
                                    stroke-linecap: round;
                                    stroke-linejoin: round;
                                }
                            </style>
                            <path class="logout-stroke" d="M21 12L13 12"/>
                            <path class="logout-stroke" d="M18 15L20.913 12.087C20.961 12.039 20.961 11.961 20.913 11.913L18 9"/>
                            <path class="logout-stroke" d="M16 5V4.5C16 3.67157 15.3284 3 14.5 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H14.5C15.3284 21 16 20.3284 16 19.5V19"/>
                        </svg>
                        <span style="color: var(--svg-color);">Logout</span>
                    </a>
                </li>
            </ul>           
        </nav>

        <main class="content">
            <div class="header-container">
                <div class="header-left">
                    <div class="logo">
                        <img src="../Images/bv_logo.png" alt="Logo" class="logo-img" id="main-logo">
                    </div>
                </div>

                <div class="header-center">
                    <h1>Admin Dashboard</h1>
                </div>

                <div class="header-right">
                    <div class="theme-selector">
                        <label for="theme-select">Mood:</label>
                        <select id="theme-select">
                            <option value="daylight">Daylight</option>
                            <option value="midnight">Midnight</option>
                            <option value="summer">Summer</option>
                            <option value="rain">Rain</option>
                        </select>
                    </div>
                </div>
            </div>
            <hr class="header-divider">

            <div class="profile-container">
                <div class="profile-left">
                    <div class="profile-picture-container">
                        <div class="profile-image-wrapper">
                            <img src="../uploads/profile_images/profile.svg" alt="Profile Picture" id="profile-image" class="profile-img">
                            <div class="profile-upload-overlay">
                                <label for="profile-upload">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                        <circle cx="12" cy="13" r="4"></circle>
                                    </svg>
                                </label>
                            </div>
                        </div>
                        <input type="file" id="profile-upload" name="profile-upload" accept="image/*" style="display: none;">
                    </div>
                </div>

                <div class="profile-middle">
                    <div class="profile-info">
                        <div class="profile-right"></div>
                    </div>
                </div>

                <div class="profile-edit">
                    <button class="edit-profile-btn" style="color: var(--svg-color);">Edit profile</button>
                </div>
            </div>

            <!-- New main container with single column buttons and chart -->
            <div class="new-main-container">
                <!-- Left section with buttons in single column -->
                <div class="buttons-section">
                    <div class="button-single-column" id="usersButton">
                        <a href="../Admin_HTML/bv_users.html">
                            <img src="../Images/bv_users.png" alt="Users Icon">
                            <span>Users</span>
                            <div id="usersCount">0</div>
                        </a>
                    </div>

                    <div class="button-single-column" id="usersItineraryButton">
                        <a href="../Admin_HTML/bv_usersitinerary.html">
                            <img src="../Images/bv_usersitinerary.png" alt="Users Itinerary Icon">
                            <span>User's Itinerary</span>
                            <div id="usersItineraryCount">0</div>
                        </a>
                    </div>

                    <div class="button-single-column" id="standardItineraryButton">
                        <a href="../Admin_HTML/bv_standard.html">
                            <img src="../Images/bv_standard.png" alt="Standard Itinerary Icon">
                            <span>Standard Itinerary</span>
                            <div id="standardItineraryCount">0</div>
                        </a>
                    </div>

                    <div class="button-single-column" id="feedbackButton">
                        <a href="../Admin_HTML/bv_feedbackrecord.html">
                            <img src="../Images/bv_feedback.png" alt="Feedback Icon">
                            <span>Feedback</span>
                            <div id="feedbackCount">0</div>
                        </a>
                    </div>
                </div>

                <!-- Right section with chart -->
                <div class="chart-section">
                    <div class="chart-title">Monthly User Activity</div>
                    <div class="chart-container">
                        <canvas id="userActivityChart"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Profile Modal with Single Button Layout -->
    <div id="editProfileModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h1>Edit Admin Profile</h1>
            <form id="editProfileForm">
                <div class="form-group">
                    <label>Company Name:</label>
                    <input type="text" id="company-name" name="company_name" required>
                </div>

                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="email" name="email" required>
                </div>

                <div id="message-container" style="display: none; padding: 8px; border-radius: 4px;">
                <!-- Message will be displayed here -->
                </div>

                <!-- Single Save Button with Change Password Link Below -->
                <button type="submit" id="save-changes-btn" class="modal-primary-btn-single">
                    Save Changes
                </button>
            </form>
            
            <div class="change-password-link">
                <a href="#" id="change-password-link">Change Password</a>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h1>Change Password</h1>
            
            <form id="changePasswordForm">
                <div class="form-group">
                    <label>Current Password:</label>
                    <div class="password-input-container">
                        <input type="password" id="current-password" name="current_password" placeholder="Loading..." required>
                        <span class="password-toggle" onclick="togglePassword('current-password')">
                            <i class="fas fa-eye" id="current-password-icon"></i>
                        </span>
                    </div>
                </div>

                <div class="form-group">
                    <label>New Password:</label>
                    <div class="password-input-container">
                        <input type="password" id="new-password" name="new_password" required>
                        <span class="password-toggle" onclick="togglePassword('new-password')">
                            <i class="fas fa-eye" id="new-password-icon"></i>
                        </span>
                    </div>
                    
                    <!-- Password Requirements -->
                    <div id="admin-password-requirements" class="password-requirements" style="display: none;">
                        <p>Password must contain:</p>
                        <ul class="requirement-list">
                            <li id="admin-length-req">
                                <i class="fa-solid fa-circle"></i>
                                <span>At least 8 characters length</span>
                            </li>
                            <li id="admin-number-req">
                                <i class="fa-solid fa-circle"></i>
                                <span>At least 1 number (0-9)</span>
                            </li>
                            <li id="admin-lowercase-req">
                                <i class="fa-solid fa-circle"></i>
                                <span>At least 1 lowercase letter (a-z)</span>
                            </li>
                            <li id="admin-special-req">
                                <i class="fa-solid fa-circle"></i>
                                <span>At least 1 special symbol (!, $, etc.)</span>
                            </li>
                            <li id="admin-uppercase-req">
                                <i class="fa-solid fa-circle"></i>
                                <span>At least 1 uppercase letter (A-Z)</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="form-group">
                    <label>Re-type New Password:</label>
                    <div class="password-input-container">
                        <input type="password" id="confirm-password" name="confirm_password" required>
                        <span class="password-toggle" onclick="togglePassword('confirm-password')">
                            <i class="fas fa-eye" id="confirm-password-icon"></i>
                        </span>
                    </div>
                </div>

                <div id="password-message-container" style="display: none; padding: 8px; border-radius: 4px;">
                <!-- Message will be displayed here -->
                </div>

                <div class="modal-button-container">
                    <button type="button" id="cancel-password-btn" class="modal-secondary-btn">
                       Cancel
                    </button>
                    <button type="submit" id="save-password-btn" class="modal-primary-btn">
                        Change Password
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Crop Profile Picture Modal -->
    <div id="cropProfileModal" class="modal" style="display:none;">
        <div class="modal-content crop-modal-content">
            <span class="close-button">&times;</span>
            <h1>Crop Your Profile Picture</h1>
            <div class="crop-container">
                <img id="crop-image" src="" alt="Image to crop">
            </div>
            <div class="crop-controls">
                <button id="rotate-btn">Rotate</button>
                <button id="crop-btn">Crop & Save</button>
                <button id="cancel-crop-btn">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        function fetchCounts(endpoint, elementId) {
            fetch(endpoint)
                .then(response => response.json())
                .then(data => {
                    document.getElementById(elementId).innerText = data.count;
                })
                .catch(error => console.error(`Error fetching count for ${elementId}:`, error));
        }
    
        window.onload = function() {
            // Fetch counts for the main buttons
            fetchCounts('../PHP/fetch_users_count.php', 'usersCount');
            fetchCounts('../PHP/fetch_users_itinerary_count.php', 'usersItineraryCount');
            fetchCounts('../PHP/fetch_standard_itinerary_count.php', 'standardItineraryCount');
            fetchCounts('../PHP/fetch_feedback_count.php', 'feedbackCount');
            
            // Initialize the chart
            initializeChart();
        };

        // Chart initialization function
        function initializeChart() {
            const ctx = document.getElementById('userActivityChart').getContext('2d');

            Promise.all([
                fetch('../PHP/fetch_monthly_users.php').then(res => res.json()),
                fetch('../PHP/fetch_monthly_itineraries.php').then(res => res.json())
            ])
            .then(([userData, itineraryData]) => {
                const labels = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];

                const chartData = {
                    labels: labels,
                    datasets: [
                        {
                            label: 'New Users',
                            data: userData,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            barThickness: 20
                        },
                        {
                            label: 'Itineraries Created',
                            data: itineraryData,
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                            barThickness: 20
                        }
                    ]
                };

                new Chart(ctx, {
                    type: 'bar',
                    data: chartData,
                    options: {
                        maintainAspectRatio: false,
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 5
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 0
                                }
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching chart data:', error);
            });
        }
    </script>    

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Get the current URL path
            const currentPath = window.location.pathname;

            // Select all <a> elements in the sidebar
            const menuLinks = document.querySelectorAll('.menu a');

            // Loop through the links and compare their href with the current path
            menuLinks.forEach(link => {
                if (link.getAttribute('href') === currentPath) {
                    // Add the active class to the parent <li>
                    link.parentElement.classList.add('active');
                }
            });
        });

        // Function to toggle the navigation menu
        function toggleMenu() {
        const menu = document.getElementById("nav-menu");
        menu.classList.toggle("active");
        }
    </script>

    <!-- Theme handler script -->
    <script src="../JS/theme-handler.js"></script>

    <!-- Profile Data Loading Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Fetch admin data from the PHP endpoint
            fetch('../PHP/get_admin_data.php')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error(data.error);
                        // Fallback to generic admin data if specific endpoint doesn't exist
                        const profileRight = document.querySelector('.profile-right');
                        profileRight.innerHTML = `
                            <p class="profile-name">BondVoyage Admin</p>
                            <p class="profile-email">admin@bondvoyage.com</p>
                        `;
                    } else {
                        // Populate the profile-right div with admin data (using company_name)
                        const profileRight = document.querySelector('.profile-right');
                        profileRight.innerHTML = `
                            <p class="profile-name">${data.company_name}</p>
                            <p class="profile-email">${data.email}</p>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error fetching admin data:', error);
                    // Fallback display
                    const profileRight = document.querySelector('.profile-right');
                    profileRight.innerHTML = `
                        <p class="profile-name">BondVoyage Admin</p>
                        <p class="profile-email">admin@bondvoyage.com</p>
                    `;
                });
        });
    </script>

    <!-- Password Toggle Function -->
    <script>
        function togglePassword(inputId) {
            const passwordInput = document.getElementById(inputId);
            const icon = document.getElementById(inputId + '-icon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
    </script>

    <!-- Password Requirements Validation Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const newPasswordInput = document.getElementById('new-password');
            const passwordRequirements = document.getElementById('admin-password-requirements');
            
            // Password requirement elements
            const lengthReq = document.getElementById('admin-length-req');
            const numberReq = document.getElementById('admin-number-req');
            const lowercaseReq = document.getElementById('admin-lowercase-req');
            const specialReq = document.getElementById('admin-special-req');
            const uppercaseReq = document.getElementById('admin-uppercase-req');

            // Show password requirements when new password field is focused
            newPasswordInput.addEventListener('focus', () => {
                passwordRequirements.style.display = 'block';
            });

            // Hide password requirements when new password field loses focus (only if empty)
            newPasswordInput.addEventListener('blur', () => {
                if (newPasswordInput.value === '') {
                    passwordRequirements.style.display = 'none';
                }
            });

            // Real-time password validation
            newPasswordInput.addEventListener('input', () => {
                const password = newPasswordInput.value;

                // Check length requirement (at least 8 characters)
                if (password.length >= 8) {
                    lengthReq.classList.add('valid');
                } else {
                    lengthReq.classList.remove('valid');
                }

                // Check number requirement
                if (/\d/.test(password)) {
                    numberReq.classList.add('valid');
                } else {
                    numberReq.classList.remove('valid');
                }

                // Check lowercase requirement
                if (/[a-z]/.test(password)) {
                    lowercaseReq.classList.add('valid');
                } else {
                    lowercaseReq.classList.remove('valid');
                }

                // Check special character requirement
                if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
                    specialReq.classList.add('valid');
                } else {
                    specialReq.classList.remove('valid');
                }

                // Check uppercase requirement
                if (/[A-Z]/.test(password)) {
                    uppercaseReq.classList.add('valid');
                } else {
                    uppercaseReq.classList.remove('valid');
                }

                // Hide requirements if password field is empty
                if (password === '') {
                    passwordRequirements.style.display = 'none';
                } else {
                    passwordRequirements.style.display = 'block';
                }
            });
        });
    </script>

    <!-- Function to fetch and display password last changed date as placeholder -->
    <script>
        function fetchPasswordLastChangedDate() {
            fetch('../PHP/get_admin_data.php')
                .then(response => response.json())
                .then(data => {
                    const currentPasswordInput = document.getElementById('current-password');
                    if (!data.error && data.password_changed_date_formatted) {
                        currentPasswordInput.placeholder = `Last changed: ${data.password_changed_date_formatted}`;
                    } else {
                        currentPasswordInput.placeholder = 'Last changed: Never';
                    }
                })
                .catch(error => {
                    console.error('Error fetching password last changed date:', error);
                    document.getElementById('current-password').placeholder = 'Last changed: Unknown';
                });
        }

        function resetPasswordLastChangedInfo() {
            document.getElementById('current-password').placeholder = 'Loading...';
        }
    </script>

    <!-- Modal Scripts -->
    <script>
        // Edit Profile Modal Handler
        document.querySelector(".edit-profile-btn").addEventListener("click", function () {
            document.getElementById("editProfileModal").style.display = "flex";

            // Prefill current data
            fetch('../PHP/get_admin_data.php')
                .then(res => res.json())
                .then(data => {
                    if (!data.error) {
                        document.querySelector('[name="company_name"]').value = data.company_name;
                        document.querySelector('[name="email"]').value = data.email;
                        
                        // Store initial values for comparison
                        document.getElementById('company-name').dataset.initial = data.company_name;
                        document.getElementById('email').dataset.initial = data.email;
                    }
                })
                .catch(error => {
                    console.error('Error fetching admin data for editing:', error);
                });
        });

        // Change Password Modal Handler (from Edit Profile Modal)
        document.getElementById("change-password-link").addEventListener("click", function (e) {
            e.preventDefault(); // Prevent default link behavior
            // Close edit profile modal
            document.getElementById("editProfileModal").style.display = "none";
            // Open change password modal
            document.getElementById("changePasswordModal").style.display = "flex";
            
            // Fetch and display password last changed date
            fetchPasswordLastChangedDate();
            
            // Clear all password fields and hide requirements
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            document.getElementById('password-message-container').style.display = 'none';
            document.getElementById('admin-password-requirements').style.display = 'none';
            
            // Reset all requirement classes
            const requirements = ['admin-length-req', 'admin-number-req', 'admin-lowercase-req', 'admin-special-req', 'admin-uppercase-req'];
            requirements.forEach(req => {
                document.getElementById(req).classList.remove('valid');
            });
        });

        // Cancel Password Change Handler
        document.getElementById("cancel-password-btn").addEventListener("click", function () {
            // Reset password last changed info
            resetPasswordLastChangedInfo();
            
            // Close change password modal
            document.getElementById("changePasswordModal").style.display = "none";
            // Reopen edit profile modal
            document.getElementById("editProfileModal").style.display = "flex";
        });

        // Close button handlers for all modals
        document.querySelectorAll(".close-button").forEach(button => {
            button.addEventListener("click", function () {
                // Reset password placeholder when closing change password modal
                if (document.getElementById("changePasswordModal").style.display === "flex") {
                    resetPasswordLastChangedInfo();
                }
                
                document.getElementById("editProfileModal").style.display = "none";
                document.getElementById("changePasswordModal").style.display = "none";
                document.getElementById("cropProfileModal").style.display = "none";
                document.getElementById('message-container').style.display = 'none';
                document.getElementById('password-message-container').style.display = 'none';
                document.getElementById('admin-password-requirements').style.display = 'none';
            });
        });

        // Enhanced Change Password Form submission handler with requirement validation
        document.getElementById("changePasswordForm").addEventListener("submit", function (e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('current-password').value.trim();
            const newPassword = document.getElementById('new-password').value.trim();
            const confirmPassword = document.getElementById('confirm-password').value.trim();
            
            const messageContainer = document.getElementById('password-message-container');
            
            // Validate required fields
            if (!currentPassword || !newPassword || !confirmPassword) {
                messageContainer.textContent = 'All fields are required';
                messageContainer.style.color = '#c82333';
                messageContainer.style.display = 'block';
                
                setTimeout(function () {
                    messageContainer.style.display = 'none';
                }, 5000);
                
                return;
            }
            
            // Enhanced password validation with all requirements
            if (newPassword.length < 8) {
                messageContainer.textContent = 'New password must be at least 8 characters long';
                messageContainer.style.color = '#c82333';
                messageContainer.style.display = 'block';
                
                setTimeout(function () {
                    messageContainer.style.display = 'none';
                }, 5000);
                
                return;
            }

            // Check if password contains at least one number
            if (!/\d/.test(newPassword)) {
                messageContainer.textContent = 'New password must contain at least one number (0-9)';
                messageContainer.style.color = '#c82333';
                messageContainer.style.display = 'block';
                
                setTimeout(function () {
                    messageContainer.style.display = 'none';
                }, 5000);
                
                return;
            }

            // Check if password contains at least one lowercase letter
            if (!/[a-z]/.test(newPassword)) {
                messageContainer.textContent = 'New password must contain at least one lowercase letter (a-z)';
                messageContainer.style.color = '#c82333';
                messageContainer.style.display = 'block';
                
                setTimeout(function () {
                    messageContainer.style.display = 'none';
                }, 5000);
                
                return;
            }

            // Check if password contains at least one uppercase letter
            if (!/[A-Z]/.test(newPassword)) {
                messageContainer.textContent = 'New password must contain at least one uppercase letter (A-Z)';
                messageContainer.style.color = '#c82333';
                messageContainer.style.display = 'block';
                
                setTimeout(function () {
                    messageContainer.style.display = 'none';
                }, 5000);
                
                return;
            }

            // Check if password contains at least one special character
            if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(newPassword)) {
                messageContainer.textContent = 'New password must contain at least one special symbol (!, $, etc.)';
                messageContainer.style.color = '#c82333';
                messageContainer.style.display = 'block';
                
                setTimeout(function () {
                    messageContainer.style.display = 'none';
                }, 5000);
                
                return;
            }
            
            // Validate password confirmation
            if (newPassword !== confirmPassword) {
                messageContainer.textContent = 'New passwords do not match';
                messageContainer.style.color = '#c82333';
                messageContainer.style.display = 'block';
                
                setTimeout(function () {
                    messageContainer.style.display = 'none';
                }, 5000);
                
                return;
            }
            
            // Check if new password is same as current password
            if (currentPassword === newPassword) {
                messageContainer.textContent = 'New password must be different from current password';
                messageContainer.style.color = '#c82333';
                messageContainer.style.display = 'block';
                
                setTimeout(function () {
                    messageContainer.style.display = 'none';
                }, 5000);
                
                return;
            }
            
            // If validation passes, proceed with form submission
            const formData = new FormData(this);

            fetch('../PHP/change_admin_password.php', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    messageContainer.textContent = 'Password changed successfully!';
                    messageContainer.style.color = '#28a745';
                    messageContainer.style.display = 'block';
                    
                    // Update password last changed placeholder immediately
                    const currentPasswordInput = document.getElementById('current-password');
                    const now = new Date();
                    const formattedDate = now.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });
                    currentPasswordInput.placeholder = `Last changed: ${formattedDate}`;
                    
                    // Clear the form after successful change
                    setTimeout(() => {
                        document.getElementById('current-password').value = '';
                        document.getElementById('new-password').value = '';
                        document.getElementById('confirm-password').value = '';
                        document.getElementById("changePasswordModal").style.display = "none";
                        messageContainer.style.display = 'none';
                        document.getElementById('admin-password-requirements').style.display = 'none';
                        resetPasswordLastChangedInfo();
                    }, 3000);
                } else {
                    messageContainer.textContent = data.message;
                    messageContainer.style.color = '#c82333';
                    messageContainer.style.display = 'block';
                    
                    setTimeout(function () {
                        messageContainer.style.display = 'none';
                    }, 5000);
                }
            })
            .catch(error => {
                console.error('Error changing password:', error);
                messageContainer.textContent = 'An error occurred while changing password';
                messageContainer.style.color = '#c82333';
                messageContainer.style.display = 'block';
                
                setTimeout(function () {
                    messageContainer.style.display = 'none';
                }, 5000);
            });
        });

        // Edit Profile Form submission handler
        document.getElementById("editProfileForm").addEventListener("submit", function (e) {
            e.preventDefault();
            
            // Get current values
            const companyName = document.getElementById('company-name').value.trim();
            const email = document.getElementById('email').value.trim();
            
            // Get initial values
            const initialCompanyName = document.getElementById('company-name').dataset.initial;
            const initialEmail = document.getElementById('email').dataset.initial;
            
            const messageContainer = document.getElementById('message-container');
            
            // Validate required fields
            if (!companyName || !email) {
                messageContainer.textContent = 'All fields are required';
                messageContainer.style.color = '#c82333';
                messageContainer.style.display = 'block';
                
                setTimeout(function () {
                    messageContainer.style.display = 'none';
                }, 5000);
                
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                messageContainer.textContent = 'Please enter a valid email address';
                messageContainer.style.color = '#c82333';
                messageContainer.style.display = 'block';
                
                setTimeout(function () {
                    messageContainer.style.display = 'none';
                }, 5000);
                
                return;
            }
            
            // Check if changes were made
            const changesMade = companyName !== initialCompanyName || email !== initialEmail;
            
            if (!changesMade) {
                messageContainer.textContent = 'No changes were made';
                messageContainer.style.color = '#c82333';
                messageContainer.style.display = 'block';
                
                setTimeout(function () {
                    messageContainer.style.display = 'none';
                }, 5000);
                
                return;
            }
            
            // If validation passes and changes were made, proceed with form submission
            const formData = new FormData(this);

            fetch('../PHP/update_admin_data.php', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    messageContainer.textContent = 'Profile updated successfully!';
                    messageContainer.style.color = '#28a745';
                    messageContainer.style.display = 'block';
                    
                    setTimeout(() => {
                        location.reload();
                    }, 3000);
                } else {
                    messageContainer.textContent = data.message;
                    messageContainer.style.color = '#c82333';
                    messageContainer.style.display = 'block';
                    
                    setTimeout(function () {
                        messageContainer.style.display = 'none';
                    }, 5000);
                }
            })
            .catch(error => {
                console.error('Error updating admin data:', error);
                messageContainer.textContent = 'An error occurred while updating profile';
                messageContainer.style.color = '#c82333';
                messageContainer.style.display = 'block';
                
                setTimeout(function () {
                    messageContainer.style.display = 'none';
                }, 5000);
            });
        });
    </script>

    <!-- Profile Picture Upload Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Elements
            const profileUpload = document.getElementById('profile-upload');
            const profileImage = document.getElementById('profile-image');
            const cropModal = document.getElementById('cropProfileModal');
            const cropImage = document.getElementById('crop-image');
            const cropBtn = document.getElementById('crop-btn');
            const rotateBtn = document.getElementById('rotate-btn');
            const cancelCropBtn = document.getElementById('cancel-crop-btn');
            
            let cropper = null;
            
            // Fetch the admin's current profile image
            fetchAdminProfileImage();
            
            // Set up the file upload event listener
            profileUpload.addEventListener('change', function(event) {
                if (event.target.files && event.target.files[0]) {
                    const file = event.target.files[0];
                    
                    // Basic validation
                    if (!file.type.match('image.*')) {
                        alert('Please select an image file');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // Show the crop modal with the selected image
                        cropImage.src = e.target.result;
                        cropModal.style.display = 'flex';
                        
                        // Initialize cropper
                        if (cropper) {
                            cropper.destroy();
                        }
                        
                        // Initialize Cropper.js
                        if (typeof Cropper !== 'undefined') {
                            cropper = new Cropper(cropImage, {
                                aspectRatio: 1,
                                viewMode: 1,
                                autoCropArea: 0.8,
                                responsive: true,
                                guides: true,
                                center: true,
                                highlight: false,
                                background: false,
                                cropBoxMovable: true,
                                cropBoxResizable: true,
                                toggleDragModeOnDblclick: false
                            });
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Rotate button functionality
            rotateBtn.addEventListener('click', function() {
                if (cropper) {
                    cropper.rotate(90);
                }
            });
            
            // Crop and save button functionality
            cropBtn.addEventListener('click', function() {
                if (cropper) {
                    const canvas = cropper.getCroppedCanvas({
                        width: 300,
                        height: 300,
                        minWidth: 100,
                        minHeight: 100,
                        maxWidth: 1000,
                        maxHeight: 1000,
                        fillColor: '#fff',
                        imageSmoothingQuality: 'high'
                    });
                    
                    if (canvas) {
                        canvas.toBlob(function(blob) {
                            const formData = new FormData();
                            formData.append('profile_image', blob, 'profile.jpg');
                            
                            // Send to admin-specific upload endpoint
                            fetch('../PHP/upload_admin_profile_image.php', {
                                method: 'POST',
                                body: formData
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    profileImage.src = data.image_path + '?t=' + new Date().getTime();
                                    cropModal.style.display = 'none';
                                    cropper.destroy();
                                    cropper = null;
                                    
                                    const messageContainer = document.getElementById('message-container');
                                    messageContainer.textContent = 'Profile picture updated successfully!';
                                    messageContainer.style.color = '#28a745';
                                    messageContainer.style.backgroundColor = '#d4edda';
                                    messageContainer.style.border = '1px solid #c3e6cb';
                                    messageContainer.style.display = 'block';
                                    
                                    setTimeout(() => {
                                        messageContainer.style.display = 'none';
                                    }, 3000);
                                } else {
                                    alert('Error: ' + data.message);
                                }
                            })
                            .catch(error => {
                                console.error('Error uploading image:', error);
                                alert('An error occurred while uploading the image');
                            });
                        }, 'image/jpeg', 0.9);
                    }
                }
            });
            
            // Cancel crop button
            cancelCropBtn.addEventListener('click', function() {
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                cropModal.style.display = 'none';
                profileUpload.value = '';
            });
            
            // Function to fetch the admin's current profile image
            function fetchAdminProfileImage() {
                fetch('../PHP/get_admin_data.php')
                    .then(response => response.json())
                    .then(data => {
                        if (!data.error && data.profile_image) {
                            profileImage.src = '../Uploads/admin_profile_images/' + data.profile_image + '?t=' + new Date().getTime();
                        } else {
                            profileImage.src = '../uploads/profile_images/profile.svg';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching admin profile image:', error);
                        profileImage.src = '../uploads/profile_images/profile.svg';
                    });
            }
        });
    </script>

</body>
</html>